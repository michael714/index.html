import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import {
  getAuth,
  signInWithCustomToken,
  signInAnonymously,
  onAuthStateChanged
} from 'firebase/auth';
import {
  getFirestore,
  doc,
  setDoc,
  collection,
  query,
  onSnapshot,
  getDocs,
  where,
  addDoc
} from 'firebase/firestore';

// Tailwind CSS is automatically included in this environment.

function App() {
  const [students, setStudents] = useState([]);
  const [periods, setPeriods] = useState([]);
  const [selectedPeriod, setSelectedPeriod] = useState('All');
  const [currentStudentIndex, setCurrentStudentIndex] = useState(0);
  const [isFlipped, setIsFlipped] = useState(false);
  const [loading, setLoading] = useState(true);
  const [userId, setUserId] = useState('');

  // Firebase globals from the environment
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';

  useEffect(() => {
    // 1. Initialize Firebase and authenticate the user
    let unsubscribe = () => {};
    const initFirebase = async () => {
      try {
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Sign in the user
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, async (user) => {
          if (user) {
            setUserId(user.uid);
            console.log('Firebase user authenticated:', user.uid);

            // 2. Sample data to seed the database if it's empty
            const studentsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'students');
            const studentsSnapshot = await getDocs(studentsRef);

            if (studentsSnapshot.empty) {
              const sampleStudents = [
                {
                  name: 'Elias Finch',
                  photoUrl: 'https://placehold.co/400x400/007bff/ffffff?text=Elias',
                  funFact: 'Can solve a Rubik\'s Cube in under a minute.',
                  experience: 'Has been programming since he was 12.',
                  period: 'Period 1'
                },
                {
                  name: 'Luna Vance',
                  photoUrl: 'https://placehold.co/400x400/e83e8c/ffffff?text=Luna',
                  funFact: 'Loves to write poetry in her free time.',
                  experience: 'Expert in front-end web development.',
                  period: 'Period 1'
                },
                {
                  name: 'James Cole',
                  photoUrl: 'https://placehold.co/400x400/28a745/ffffff?text=James',
                  funFact: 'Won a regional chess tournament last year.',
                  experience: 'Strong background in data analysis.',
                  period: 'Period 2'
                },
                {
                  name: 'Ava Chen',
                  photoUrl: 'https://placehold.co/400x400/ffc107/000000?text=Ava',
                  funFact: 'Is learning to play the ukulele.',
                  experience: 'Specializes in machine learning algorithms.',
                  period: 'Period 2'
                },
              ];

              for (const student of sampleStudents) {
                await addDoc(studentsRef, student);
              }
              console.log('Sample data added to Firestore.');
            }

            // 3. Listen for real-time changes to the flashcards
            const getStudents = () => {
              let q;
              if (selectedPeriod === 'All') {
                q = query(studentsRef);
              } else {
                q = query(studentsRef, where('period', '==', selectedPeriod));
              }

              unsubscribe = onSnapshot(q, (querySnapshot) => {
                const studentsArray = [];
                const allPeriods = new Set();
                querySnapshot.forEach((doc) => {
                  const studentData = { id: doc.id, ...doc.data() };
                  studentsArray.push(studentData);
                  allPeriods.add(studentData.period);
                });
                
                // Sort students by name for consistent display
                studentsArray.sort((a, b) => a.name.localeCompare(b.name));
                
                setStudents(studentsArray);
                setPeriods(['All', ...Array.from(allPeriods).sort()]);
                setLoading(false);
                setCurrentStudentIndex(0); // Reset to the first card when period changes
                setIsFlipped(false); // Reset card flip state
              });
            };
            getStudents();
          } else {
            console.log('No user is signed in.');
            setLoading(false);
          }
        });

      } catch (error) {
        console.error('Error initializing Firebase or fetching data:', error);
        setLoading(false);
      }
    };
    initFirebase();
    
    // Clean up the subscription on unmount
    return () => unsubscribe();
  }, [selectedPeriod, appId, firebaseConfig, initialAuthToken]);

  const handleNext = () => {
    setIsFlipped(false);
    setTimeout(() => {
      setCurrentStudentIndex((prevIndex) => (prevIndex + 1) % students.length);
    }, 300); // Match animation duration
  };

  const handlePrev = () => {
    setIsFlipped(false);
    setTimeout(() => {
      setCurrentStudentIndex((prevIndex) => (prevIndex - 1 + students.length) % students.length);
    }, 300); // Match animation duration
  };

  const handleCardClick = () => {
    setIsFlipped(!isFlipped);
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-slate-100">
        <p className="text-xl text-gray-700">Loading flashcards...</p>
      </div>
    );
  }

  const currentStudent = students[currentStudentIndex];

  return (
    <div className="bg-slate-100 min-h-screen flex flex-col items-center justify-center p-4 font-sans text-gray-800">
      <div className="w-full max-w-2xl text-center mb-8">
        <h1 className="text-4xl font-bold mb-2">Student Flashcards</h1>
        <p className="text-sm text-gray-500">User ID: {userId}</p>
      </div>

      <div className="w-full max-w-sm mb-6">
        <label htmlFor="period-select" className="block text-sm font-medium text-gray-700 mb-1">
          Select Period
        </label>
        <select
          id="period-select"
          value={selectedPeriod}
          onChange={(e) => setSelectedPeriod(e.target.value)}
          className="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2"
        >
          {periods.map((period) => (
            <option key={period} value={period}>
              {period}
            </option>
          ))}
        </select>
      </div>
      
      {students.length > 0 ? (
        <>
          {/* Flashcard container with flip animation */}
          <div
            className={`w-full max-w-sm h-96 transform-style-3d relative transition-transform duration-300 ${isFlipped ? 'rotate-y-180' : ''}`}
            onClick={handleCardClick}
          >
            {/* Front of the card (photo) */}
            <div className="absolute w-full h-full backface-hidden bg-white rounded-xl shadow-lg flex items-center justify-center overflow-hidden cursor-pointer">
              {currentStudent.photoUrl && (
                <img
                  src={currentStudent.photoUrl}
                  alt={`Photo of ${currentStudent.name}`}
                  className="w-full h-full object-cover"
                />
              )}
            </div>

            {/* Back of the card (details) */}
            <div className="absolute w-full h-full backface-hidden bg-white rounded-xl shadow-lg rotate-y-180 p-6 flex flex-col justify-center items-center text-center cursor-pointer">
              <h2 className="text-3xl font-bold mb-4">{currentStudent.name}</h2>
              <div className="text-lg space-y-3">
                <p><strong>Fun Fact:</strong> {currentStudent.funFact}</p>
                <p><strong>Experience:</strong> {currentStudent.experience}</p>
              </div>
            </div>
          </div>

          {/* Navigation buttons */}
          <div className="flex justify-between w-full max-w-sm mt-8">
            <button
              onClick={(e) => { e.stopPropagation(); handlePrev(); }}
              className="px-6 py-3 bg-white text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-200 transition-colors duration-200"
            >
              Previous
            </button>
            <button
              onClick={(e) => { e.stopPropagation(); handleNext(); }}
              className="px-6 py-3 bg-white text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-200 transition-colors duration-200"
            >
              Next
            </button>
          </div>
        </>
      ) : (
        <div className="w-full max-w-sm h-96 bg-white rounded-xl shadow-lg flex items-center justify-center">
          <p className="text-lg text-gray-500">No students found for this period.</p>
        </div>
      )}

      {/* Add some basic styles for the card flip effect */}
      <style>{`
        .transform-style-3d {
          transform-style: preserve-3d;
        }
        .backface-hidden {
          backface-visibility: hidden;
        }
        .rotate-y-180 {
          transform: rotateY(180deg);
        }
      `}</style>
    </div>
  );
}

export default App;

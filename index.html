<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Flashcard App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 800px;
        }
        .card-container {
            perspective: 1000px;
        }
        .flashcard {
            width: 100%;
            height: 500px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }
        .flashcard.is-flipped {
            transform: rotateY(180deg);
        }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .flashcard-back {
            transform: rotateY(180deg);
        }
        .flashcard-image {
            width: 100%;
            max-width: 250px;
            height: auto;
            border-radius: 1.5rem;
            object-fit: cover;
        }
        .btn {
            @apply px-6 py-3 font-semibold rounded-full shadow-lg transition-all duration-300 transform hover:scale-105;
        }
        .btn-primary {
            @apply bg-indigo-600 text-white hover:bg-indigo-700;
        }
        .modal {
            display: none;
            background-color: rgba(255,255,255,0.8);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            @apply bg-white p-8 rounded-xl shadow-2xl;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main App Content -->
    <div id="flashcard-app" class="container mx-auto p-8 bg-gray-50 rounded-3xl shadow-2xl text-center">
        <header class="mb-12">
            <h1 class="text-5xl font-bold text-indigo-700 mb-2">Student Flashcards</h1>
            <p class="text-lg text-gray-600">Click a card to flip it and reveal details.</p>
        </header>

        <main>
            <!-- Loading and Error State -->
            <div id="loading" class="flex flex-col items-center justify-center p-8">
                <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500 mb-4"></div>
                <p class="text-gray-600 text-xl">Loading student data...</p>
            </div>
            
            <div id="no-data" class="hidden text-center text-gray-600 p-8">
                <p class="text-xl">No student profiles found. Please add students using the entry app.</p>
            </div>

            <!-- Flashcard Section -->
            <div id="flashcard-section" class="hidden">
                <div class="card-container mb-8">
                    <div id="flashcard-card" class="flashcard">
                        <div id="flashcard-front" class="flashcard-face">
                            <img id="student-photo-front" class="flashcard-image" src="" alt="Student photo">
                            <h2 id="student-name" class="text-4xl font-bold text-gray-800 mt-4"></h2>
                            <p id="student-class" class="text-gray-600 text-xl"></p>
                        </div>
                        <div id="flashcard-back" class="flashcard-face">
                             <img id="student-photo-back" class="flashcard-image" src="" alt="Student photo">
                            <h3 id="student-back-name" class="text-2xl font-bold text-gray-800 mt-4"></h3>
                            <div class="space-y-4 text-left mt-4">
                                <div>
                                    <p class="font-bold text-gray-700">Fun Fact:</p>
                                    <p id="fun-facts-back" class="text-gray-600"></p>
                                </div>
                                <div>
                                    <p class="font-bold text-gray-700">Experience:</p>
                                    <p id="experience-back" class="text-gray-600"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex justify-center space-x-4">
                    <button id="prev-btn" class="btn btn-primary disabled:opacity-50">Previous</button>
                    <button id="next-btn" class="btn btn-primary disabled:opacity-50">Next</button>
                </div>
            </div>
        </main>
        
        <!-- Custom Modal UI for critical errors -->
        <div id="modal" class="modal fixed inset-0 z-50 overflow-auto flex items-center justify-center">
            <div class="modal-content w-full max-w-md">
                <h3 class="text-xl font-bold text-gray-800 mb-4">When you're ready...</h3>
                <p id="modal-message" class="text-gray-900 mb-6"></p>
                <div class="flex justify-center">
                    <button onclick="hideModal()" class="modal-close-btn px-6 py-3 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700">Start</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports & Main Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase services
        let app;
        let db;
        let auth;
        
        let studentData = [];
        let currentIndex = 0;

        window.onload = async function() {
            // DOM elements
            const loadingScreen = document.getElementById('loading');
            const flashcardSection = document.getElementById('flashcard-section');
            const noDataMessage = document.getElementById('no-data');
            const flashcardCard = document.getElementById('flashcard-card');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            // Student Card elements
            const studentPhotoFront = document.getElementById('student-photo-front');
            const studentPhotoBack = document.getElementById('student-photo-back');
            const studentName = document.getElementById('student-name');
            const studentClass = document.getElementById('student-class');
            const studentBackName = document.getElementById('student-back-name');
            const funFactsBack = document.getElementById('fun-facts-back');
            const experienceBack = document.getElementById('experience-back');

            // IMPORTANT: You MUST replace the content below with your actual Firebase config.

                const firebaseConfig = {
                apiKey: "AIzaSyD7jyL6ZehEBPXCvzhDI59rO-Gtry36bwk",
                authDomain: "student-flashcards.firebaseapp.com",
                projectId: "student-flashcards",
                storageBucket: "student-flashcards.firebasestorage.app",
                messagingSenderId: "737854832974",
                appId: "1:737854832974:web:536a0574d8868bc84d1e1f"
                };
            
            // This is the same app ID used in the Student Entry App
            const appId = 'student-entry-app-2025';

            if (!firebaseConfig.projectId) {
                showModal("Error: Firebase configuration is missing. Please add your config to the code and redeploy.");
                console.error("Firebase Initialization Error: The firebaseConfig object is empty or missing 'projectId'.");
                return;
            }
            
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Auth state change listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("User signed in with ID:", user.uid);
                        await fetchStudentData();
                    } else {
                        try {
                           console.log("No user signed in. Attempting anonymous sign-in.");
                           await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Error during anonymous sign-in:", error);
                            showModal("Error: Sign-in failed. Please check your Firebase Authentication settings.");
                        }
                    }
                });
            } catch (e) {
                console.error("Error initializing Firebase:", e);
                showModal("Critical Error: Firebase initialization failed. Please check your config and redeploy.");
            }

            // Function to fetch student data from Firestore
            async function fetchStudentData() {
                try {
                    const collectionPath = `artifacts/${appId}/public/data/student-profiles`;
                    const q = query(collection(db, collectionPath));
                    const querySnapshot = await getDocs(q);

                    studentData = [];
                    querySnapshot.forEach((doc) => {
                        studentData.push(doc.data());
                    });
                    
                    if (studentData.length > 0) {
                        console.log("Student data fetched successfully:", studentData);
                        displayStudentCard(currentIndex);
                        flashcardSection.classList.remove('hidden');
                    } else {
                        noDataMessage.classList.remove('hidden');
                    }
                } catch (e) {
                    console.error("Error fetching documents:", e);
                    showModal("Error: Could not fetch student data. Please check your Firestore rules.");
                } finally {
                    loadingScreen.classList.add('hidden');
                }
            }

            // Function to display a student card
            function displayStudentCard(index) {
                const student = studentData[index];
                if (student) {
                    studentName.textContent = student.preferredName || student.name;
                    studentClass.textContent = student.className;
                    studentPhotoFront.src = student.photo;
                    studentPhotoBack.src = student.photo;
                    studentBackName.textContent = student.preferredName || student.name;
                    funFactsBack.textContent = student.funFacts;
                    experienceBack.textContent = student.experience;
                    
                    // Reset card flip and disable/enable buttons
                    flashcardCard.classList.remove('is-flipped');
                    prevBtn.disabled = index === 0;
                    nextBtn.disabled = index === studentData.length - 1;
                }
            }

            // Event listener for card flip
            flashcardCard.addEventListener('click', () => {
                flashcardCard.classList.toggle('is-flipped');
            });

            // Event listener for previous button
            prevBtn.addEventListener('click', () => {
                if (currentIndex > 0) {
                    currentIndex--;
                    displayStudentCard(currentIndex);
                }
            });

            // Event listener for next button
            nextBtn.addEventListener('click', () => {
                if (currentIndex < studentData.length - 1) {
                    currentIndex++;
                    displayStudentCard(currentIndex);
                }
            });

            // Function to show a custom modal for critical errors
            window.showModal = (message) => {
                const modal = document.getElementById('modal');
                const modalMessage = document.getElementById('modal-message');
                if (modal && modalMessage) {
                    modalMessage.textContent = message;
                    modal.style.display = 'flex';
                }
            };

            // Function to hide the custom modal
            window.hideModal = () => {
                const modal = document.getElementById('modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            };
        };
    </script>
</body>
</html>

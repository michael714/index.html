<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Flashcards</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS for the card flip animation */
        .card-container {
            perspective: 1000px;
        }
        .card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .card.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .card-face.card-back {
            transform: rotateY(180deg);
        }
    </style>
</head>
<body class="bg-slate-100 flex flex-col items-center justify-center min-h-screen p-4 font-sans text-gray-800">

    <div class="w-full max-w-2xl text-center mb-8">
        <h1 class="text-4xl font-bold mb-2">Student Flashcards</h1>
    </div>

    <!-- Period filter dropdown -->
    <div class="w-full max-w-sm mb-6">
        <label for="period-select" class="block text-sm font-medium text-gray-700 mb-1">
            Select Period
        </label>
        <select id="period-select" class="block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm focus:border-indigo-500 focus:ring-indigo-500">
            <option value="All">All</option>
            <option value="Period 1">Period 1</option>
            <option value="Period 2">Period 2</option>
            <option value="Period 3">Period 3</option>
            <option value="Period 4">Period 4</option>
            <option value="Period 6">Period 6</option>
        </select>
    </div>

    <!-- Flashcard UI -->
    <div id="flashcard-container" class="w-full max-w-sm card-container">
        <div id="flashcard" class="card cursor-pointer">
            <!-- Card Front -->
            <div id="card-front" class="card-face bg-white">
                <img id="student-photo" src="https://placehold.co/400x400/cccccc/000000?text=Loading..." alt="Student Photo" class="w-full h-full object-cover rounded-xl">
            </div>
            <!-- Card Back -->
            <div id="card-back" class="card-face card-back bg-white p-6 flex-col text-center">
                <h2 id="student-name" class="text-3xl font-bold mb-4"></h2>
                <div class="text-lg space-y-3">
                    <p><strong>Fun Fact:</strong> <span id="fun-fact"></span></p>
                    <p><strong>Experience:</strong> <span id="experience"></span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation buttons -->
    <div class="flex justify-between w-full max-w-sm mt-8">
        <button id="prev-btn" class="px-6 py-3 bg-white text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-200 transition-colors duration-200">
            Previous
        </button>
        <button id="next-btn" class="px-6 py-3 bg-white text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-200 transition-colors duration-200">
            Next
        </button>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ====================================================================
        // IMPORTANT: YOUR FIREBASE CONFIGURATION AND COLLECTION NAME
        // ====================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyD7jyL6ZehEBPXCvzhDI59rO-Gtry36bwk",
            authDomain: "student-flashcards.firebaseapp.com",
            projectId: "student-flashcards",
            storageBucket: "student-flashcards.firebasestorage.app",
            messagingSenderId: "737854832974",
            appId: "1:737854832974:web:536a0574d8868bc84d1e1f"
        };
        const firestoreCollectionName = "/artifacts/student-entry-app-2025/public/data/student-profiles";
        // ====================================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const flashcardElement = document.getElementById('flashcard');
        const nextButton = document.getElementById('next-btn');
        const prevButton = document.getElementById('prev-btn');
        const periodSelect = document.getElementById('period-select');
        let filteredStudents = [];
        let currentIndex = 0;

        const updateFlashcard = async () => {
            const photoElement = document.getElementById('student-photo');
            const nameElement = document.getElementById('student-name');
            const funFactElement = document.getElementById('fun-fact');
            const experienceElement = document.getElementById('experience');

            // Revoke previous object URL to prevent memory leaks
            if (photoElement.src.startsWith('blob:')) {
                URL.revokeObjectURL(photoElement.src);
            }

            if (filteredStudents.length === 0) {
                photoElement.src = "https://placehold.co/400x400/cccccc/000000?text=No+Students+Found";
                nameElement.textContent = "No students in this period.";
                funFactElement.textContent = "";
                experienceElement.textContent = "";
                nextButton.style.display = 'none';
                prevButton.style.display = 'none';
                return;
            }

            nextButton.style.display = 'inline-flex';
            prevButton.style.display = 'inline-flex';

            const student = filteredStudents[currentIndex];
            
            // Handle inconsistent name fields
            nameElement.textContent = student.name || student.preferredName || "Unknown Name";
            funFactElement.textContent = student.funFacts || student.funFact || "N/A";
            experienceElement.textContent = student.experience || "N/A";

            // Use fetch to handle base64 data more reliably
            if (student.photo && student.photo.startsWith('data:')) {
                photoElement.src = "https://placehold.co/400x400/eeeeee/333333?text=Loading..."; // Set a loading placeholder
                try {
                    // Use fetch to get the blob from the data URL
                    const response = await fetch(student.photo);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const blob = await response.blob();
                    photoElement.src = URL.createObjectURL(blob);
                    photoElement.onerror = () => {
                        console.error("Blob URL failed to load. The image data might be corrupt.");
                        photoElement.src = "https://placehold.co/400x400/cccccc/000000?text=Corrupt+Image";
                    };
                } catch (e) {
                    console.error("Failed to process base64 image data:", e);
                    photoElement.src = "https://placehold.co/400x400/cccccc/000000?text=Invalid+Data";
                }
            } else if (student.photoUrl) {
                photoElement.src = student.photoUrl;
                photoElement.onerror = () => {
                    console.error("External image URL failed to load.");
                    photoElement.src = "https://placehold.co/400x400/cccccc/000000?text=No+Photo";
                };
            } else {
                photoElement.src = "https://placehold.co/400x400/cccccc/000000?text=No+Photo";
            }
        };

        const fetchStudents = async (period) => {
            try {
                const studentsCollection = collection(db, firestoreCollectionName);
                let q;
                if (period === 'All') {
                    q = query(studentsCollection);
                } else {
                    let periodValue;
                    switch(period) {
                        case 'Period 1': periodValue = "1"; break;
                        case 'Period 2': periodValue = "2"; break;
                        case 'Period 3': periodValue = "3"; break;
                        case 'Period 4': periodValue = "4"; break;
                        case 'Period 6': periodValue = "6"; break;
                        default: periodValue = null;
                    }
                    
                    if (periodValue !== null) {
                        q = query(studentsCollection, where("period", "==", periodValue));
                    } else {
                        q = query(collection(db, "a_non_existent_collection_to_return_nothing"));
                    }
                }
                
                const querySnapshot = await getDocs(q);
                filteredStudents = querySnapshot.docs.map(doc => doc.data());
                
                console.log(`Found ${filteredStudents.length} students for period: ${period}`);
                console.log(filteredStudents);
                
                currentIndex = 0;
                flashcardElement.classList.remove('is-flipped');
                updateFlashcard();

            } catch (e) {
                console.error("Error fetching students: ", e);
                document.getElementById('student-photo').src = "https://placehold.co/400x400/ff0000/ffffff?text=Error";
                document.getElementById('student-name').textContent = "Error loading data.";
                document.getElementById('fun-fact').textContent = "Please check your Firebase config and collection name. Also, ensure your Firebase security rules allow read access.";
                document.getElementById('experience').textContent = "";
                nextButton.style.display = 'none';
                prevButton.style.display = 'none';
            }
        };

        // Event listeners
        flashcardElement.addEventListener('click', () => {
            if (filteredStudents.length > 0) {
                flashcardElement.classList.toggle('is-flipped');
            }
        });

        nextButton.addEventListener('click', (event) => {
            event.stopPropagation();
            if (filteredStudents.length > 0) {
                flashcardElement.classList.remove('is-flipped');
                setTimeout(() => {
                    currentIndex = (currentIndex + 1) % filteredStudents.length;
                    updateFlashcard();
                }, 600);
            }
        });

        prevButton.addEventListener('click', (event) => {
            event.stopPropagation();
            if (filteredStudents.length > 0) {
                flashcardElement.classList.remove('is-flipped');
                setTimeout(() => {
                    currentIndex = (currentIndex - 1 + filteredStudents.length) % filteredStudents.length;
                    updateFlashcard();
                }, 600);
            }
        });

        periodSelect.addEventListener('change', (event) => {
            const selectedPeriod = event.target.value;
            fetchStudents(selectedPeriod);
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetchStudents('All');
        });
    </script>
</body>
</html>
